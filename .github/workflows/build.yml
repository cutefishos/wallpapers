name: Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  Ubuntu:
    name: Ubuntu latest build 
    runs-on: ubuntu-latest
    permissions: write-all
  
    steps:
    - name: Checkout Source
      uses: actions/checkout@v3

    - name: Add Simple Linux DE repository
      run : | 
        sudo mkdir -p  /etc/apt/sources.list.d
        sudo bash  -c "echo 'deb [trusted=yes] https://gitcode.net/simple-linux-de/debserver/-/raw/master unstable main contrib non-free' > /etc/apt/sources.list.d/simplelinux.list"

    - name: Update repository
      run: sudo apt update -y

    - name: Install the basic dev packages

      run: sudo apt install -y equivs curl git devscripts lintian build-essential automake autotools-dev cmake g++  cutefish-core  cutefish-kwin-plugins  cutefish-qt-plugins  fishui  libcutefish

    - name: Install build dependencies
      run: sudo mk-build-deps -i -t "apt-get --yes" -r

    - name: Build Package
      run: sudo dpkg-buildpackage -b -uc -us -nc -tc -j$(nproc)

    - name: Get current date
      id: date
      run: echo "::set-output name=today::$(date +'%Y-%m-%d-%s')"

    - name: Upload build
      uses: "marvinpinto/action-automatic-releases@latest"
      with:
        repo_token: "${{ secrets.GITHUB_TOKEN }}"
        automatic_release_tag: "autobuild"
        prerelease: true
        title: "Development Build ${{ steps.date.outputs.today }}"
        files: |
          ../**/*.deb
          ../**/*.ddeb
          ../**/*.buildinfo
          ../**/*.changes